{"version":3,"sources":["node_modules/browser-pack/_prelude.js","src/main.js","src/Character5e.js","src/Manager.js"],"names":["rules","require","Manager","navigator","serviceWorker","register","scope","initialize","prefix","appname","character_model","app","key","charname","charclass","race","background","alignment","level","experience","inspiration","proficiency","armor_class","speed","hp_cur","hp_max","hd_cur","hd_max","deathSave","success","fail","str","dex","con","intel","wis","cha","saves","skills","acrobatics","animal_handling","arcana","athletics","deception","history","insight","intimidation","investigation","medicine","nature","perception","performance","persuasion","religion","sleight_of_Hand","stealth","survival","weapons","proficiencies_other","languages","traits","ideals","bonds","flaws","appearance","equipment","cp","sp","gp","pp","features","notes","notes_adv","notes_cam","spell_ability","spell_save","spell_attack","spell_slots","1","2","3","4","5","6","7","8","9","spells","0","updated","ui","attribute_fields","Array","from","document","querySelectorAll","attribute_saves","skill_checks","dialog_unsaved","querySelector","spell_lists","calcAttrMod","val","raw","Math","floor","calcSaveMod","attr","prof","attr_field","parentNode","attr_mod","innerHTML","save_mod","checked","parseInt","calcSkillMod","el","skill_checked","attribute","getAttribute","mod_field","nextElementSibling","this","value","innerText","calcProfMod","_this","before","bonus","ceil","after","forEach","contentEditableFocus","e","target","setAttribute","contentEditableBlur","cur_val","trimmed_cur_val","trim","replace","removeAttribute","classList","add","slevel","slots","spelllist","remove","attributeChange","_this2","field","currentTarget","saveChange","skillChange","spellKeyPress","tagName","closest","which","preventDefault","li","createElement","appendChild","focus","postRender","event","Event","dispatchEvent","_this3","addEventListener","bind","intro","content","h","push","p1","p4","p2","p3","module","exports","model","Storage","setPrefix","get","txt","localStorage","getItem","set","JSON","parse","setItem","stringify","removeItem","getAllKeys","keys","length","key_regex","RegExp","i","indexOf","match","ActionMenu","opener","contains","style","overflow","toggle","window","getComputedStyle","getPropertyValue","action_btn_backup","BackupDialog","open","action_btn_save","saveCharacter","action_btn_new","location","hash","generateKey","action_btn_restore","action_btn_load","LoadMenu","close","addCharacter","char_obj","existing","textContent","a","del","console","log","message","removeCharacter","loadlink","removeChild","isEmpty","body","id","deletePrompt","Alert","setContent","isArray","clear","f","createDocumentFragment","btn","firstChild","deleteCharacter","HelpDialog","getElementById","closer","_this4","type","addRestoreForm","addDownloadForm","getCloseButton","button","form","fields","restoreFormSubmit","checkboxes","join","downloadBackup","altDownload","data","p","text","select","emailDownload","link","_this5","rules_ui","cur_character","characterJSON","obj","prop","currentTimestamp","d","Date","toUTCString","random","toString","slice","setCurCharacterData","_this6","_typeof","props","Object","changeCharacter","urlhash","substr","loadCharacter","create","renderCharacter","_this7","subf","items","split","li_blank","insertBefore","event2","_this8","hasOwnProperty","lis","_this9","names","checks","ch","format","date","href","url","encodeURIComponent","toLocaleString","_ret3","Blob","v","file","URL","createObjectURL","download","getFullYear","getMonth","getDate","click","setTimeout","revokeObjectURL","_this10","input_file","input","files","reader","FileReader","onload","theFile","restoreCharacters","result","readAsText","_this11","start","end","lastIndexOf","check","substring","backups","imported_chars","Error","ex_char","key_prev","temp_key","ul","checkFeatures","checkCache","updateAppCache","applicationCache","status","UPDATEREADY","showIntroDialog","settings","_this12","target_id","scrollIntoView"],"mappings":"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","file":"bundle.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","const rules = require('./Character5e.js');\nconst Manager = require('./Manager.js');\n\n/**\n * Register service worker if it's supported\n */\nif ('serviceWorker' in navigator) {\n\tnavigator.serviceWorker.register('service_worker.js', {\n\t\tscope: '/'\n\t});\n}\n\nManager.initialize({\n\trules: rules,\n\tprefix: 'charsheet-5e-',\n\tappname: 'character-sheet-5e'\n});\n","/**\n * Exports:\n * model: Model for 5e character data\n * ui: events/handlers/functions\n */\nconst character_model = {\n\tapp: 'character-sheet-5e',\n\tkey: '',\n\tcharname: '',\n\tcharclass: '',\n\trace: '',\n\tbackground: '',\n\talignment: '',\n\tlevel: 1,\n\texperience: 0,\n\tinspiration: '',\n\tproficiency: '+2',\n\tarmor_class: '',\n\tspeed: 30,\n\thp_cur: '',\n\thp_max: '',\n\thd_cur: '',\n\thd_max: '',\n\tdeathSave: {\n\t\tsuccess: 0,\n\t\tfail: 0\n\t},\n\tstr: 10,\n\tdex: 10,\n\tcon: 10,\n\tintel: 10,\n\twis: 10,\n\tcha: 10,\n\tsaves: {\n\t\t'str': 0,\n\t\t'dex': 0,\n\t\t'con': 0,\n\t\t'intel': 0,\n\t\t'wis': 0,\n\t\t'cha': 0\n\t},\n\tskills: {\n\t\tacrobatics: 0,\n\t\tanimal_handling: 0,\n\t\tarcana: 0,\n\t\tathletics: 0,\n\t\tdeception: 0,\n\t\thistory: 0,\n\t\tinsight: 0,\n\t\tintimidation: 0,\n\t\tinvestigation: 0,\n\t\tmedicine: 0,\n\t\tnature: 0,\n\t\tperception: 0,\n\t\tperformance: 0,\n\t\tpersuasion: 0,\n\t\treligion: 0,\n\t\tsleight_of_Hand: 0,\n\t\tstealth: 0,\n\t\tsurvival: 0\n\t},\n\tweapons: '',\n\tproficiencies_other: '',\n\tlanguages: '',\n\ttraits: '',\n\tideals: '',\n\tbonds: '',\n\tflaws: '',\n\tappearance: '',\n\tequipment: '',\n\tcp: '',\n\tsp: '',\n\tgp: '',\n\tpp: '',\n\tfeatures: '',\n\tnotes: '',\n\tnotes_adv: '',\n\tnotes_cam: '',\n\tspell_ability: '',\n\tspell_save: '',\n\tspell_attack: '',\n\tspell_slots: {\n\t\t1: 0,\n\t\t2: 0,\n\t\t3: 0,\n\t\t4: 0,\n\t\t5: 0,\n\t\t6: 0,\n\t\t7: 0,\n\t\t8: 0,\n\t\t9: 0\n\t},\n\tspells: {\n\t\t0: [],\n\t\t1: '',\n\t\t2: '',\n\t\t3: '',\n\t\t4: '',\n\t\t5: '',\n\t\t6: '',\n\t\t7: '',\n\t\t8: '',\n\t\t9: ''\n\t},\n\tupdated: ''\n};\n\n/**\n * 5e specific UI events and functions\n */\nconst ui = {\n\t/**\n\t * Attribute inputs\n\t */\n\tattribute_fields: Array.from(document.querySelectorAll('.pc-attributes input[type=number]')),\n\t/**\n\t * Saving throw checkboxes\n\t */\n\tattribute_saves: Array.from(document.querySelectorAll('.pc-attributes input[type=checkbox]')),\n\t/**\n\t * Skill checkboxes\n\t */\n\tskill_checks: Array.from(document.querySelectorAll('input[data-name=\"skills\"]')),\n\t/**\n\t * Unsaved data alert\n\t */\n\tdialog_unsaved: document.querySelector('.alert-unsaved'),\n\t/**\n\t * Spell Lists\n\t */\n\tspell_lists: Array.from(document.querySelectorAll('ul[data-name=spells]')),\n\t/**\n\t * Calculate the attribute modifier based on the score\n\t * @return {String|Number} 0, a negative number, or a positive number preceded by a +\n\t */\n\tcalcAttrMod: function (val) {\n\t\tconst raw = Math.floor((val - 10) / 2);\n\t\treturn (raw > 0) ? `+${raw}` : raw;\n\t},\n\t/**\n\t * Calculate the save modifier based on the score, proficiency, and prof bonus\n\t * and set it\n\t * @param {String} attr attribute name\n\t */\n\tcalcSaveMod: function (attr) {\n\t\tlet prof = 0;\n\t\tconst attr_field = document.querySelector(`[data-name=${attr}]`).parentNode;\n\t\tconst attr_mod = attr_field.querySelector('.pc-attribute-mod').innerHTML;\n\t\tconst save_mod = attr_field.querySelector('.pc-save-mod');\n\t\tconst checked = attr_field.querySelector('input[type=checkbox]').checked;\n\t\tif (checked) {\n\t\t\tprof = document.querySelector('[data-name=\"proficiency\"]').innerHTML;\n\t\t\tif (prof === '') {\n\t\t\t\tprof = 0;\n\t\t\t} else {\n\t\t\t\tprof = parseInt(prof, 10);\n\t\t\t}\n\t\t}\n\t\tconst raw = 0 + parseInt(prof, 10) + parseInt(attr_mod, 10);\n\t\tsave_mod.innerHTML = (raw > 0) ? `+${raw}` : raw;\n\t},\n\t/**\n\t * Calculate the modifier for a skill based on proficiency and attribute\n\t * @param {DOMElement} el the skill checkbox element\n\t */\n\tcalcSkillMod: function (el) {\n\t\tconst skill_checked = el.checked;\n\t\tconst attribute = el.getAttribute('data-attr');\n\t\tconst mod_field = el.parentNode.nextElementSibling;\n\n\t\tlet prof = 0;\n\t\tif (skill_checked) {\n\t\t\tprof = document.querySelector('[data-name=\"proficiency\"]').innerHTML;\n\t\t\tif (prof === '') {\n\t\t\t\tprof = 0;\n\t\t\t} else {\n\t\t\t\tprof = parseInt(prof, 10);\n\t\t\t}\n\t\t}\n\t\tconst attr = document.querySelector(`[data-name=${attribute}]`);\n\t\tconst attr_mod = parseInt(this.calcAttrMod(attr.value), 10);\n\t\tconst raw = 0 + prof + attr_mod;\n\t\tmod_field.innerText = (raw > 0) ? `+${raw}` : raw;\n\t},\n\t/**\n\t * Calculate proficiency modifier based on level\n\t */\n\tcalcProfMod: function () {\n\t\tconst prof = document.querySelector(`[data-name=proficiency]`);\n\t\tconst before = prof.innerHTML;\n\t\tconst level = parseInt(document.querySelector(`[data-name=level]`).innerHTML, 10);\n\t\tconst bonus = Math.ceil(level / 4) + 1;\n\t\tconst after = `+${bonus}`;\n\t\t// did it change?\n\t\tif (before !== after) {\n\t\t\tprof.innerHTML = `+${bonus}`;\n\t\t\t// recalculate saves and skills\n\t\t\tthis.attribute_fields.forEach((el) => {\n\t\t\t\tthis.calcSaveMod(el.getAttribute('data-name'));\n\t\t\t});\n\t\t\tthis.skill_checks.forEach((el) => {\n\t\t\t\tthis.calcSkillMod(el);\n\t\t\t});\n\t\t}\n\t},\n\t/**\n\t * Save current data on contenteditable focus\n\t * @param {Object} e event object\n\t */\n\tcontentEditableFocus: function (e) {\n\t\tif (e.target.getAttribute('contenteditable') === 'true') {\n\t\t\te.target.setAttribute('data-before', e.target.innerHTML);\n\t\t}\n\t},\n\t/**\n\t * Contenteditable blue, check for change, update anything necessary\n\t * @param {Object} e event object\n\t */\n\tcontentEditableBlur: function (e) {\n\t\tif (e.target.getAttribute('contenteditable') === 'true') {\n\t\t\tconst before = e.target.getAttribute('data-before');\n\t\t\t// trim out spaces and ending linebreaks\n\t\t\tconst cur_val = e.target.innerHTML;\n\t\t\tlet trimmed_cur_val = cur_val.trim();\n\t\t\ttrimmed_cur_val = trimmed_cur_val.replace(/(<br\\/?>)+$/, '');\n\t\t\tif (trimmed_cur_val !== cur_val) {\n\t\t\t\te.target.innerHTML = trimmed_cur_val;\n\t\t\t}\n\n\t\t\tif (before !== e.target.innerHTML) {\n\t\t\t\te.target.removeAttribute('data-before');\n\t\t\t\tthis.dialog_unsaved.classList.add('open');\n\n\t\t\t\t// if level then update proficiency\n\t\t\t\tif (e.target.getAttribute('data-name') === 'level') {\n\t\t\t\t\tthis.calcProfMod();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// if spell slot changes then show/hide spell level list\n\t\t\t\tif (e.target.getAttribute('data-name') === 'spell_slots') {\n\t\t\t\t\tconst slevel = e.target.getAttribute('data-subfield');\n\t\t\t\t\tconst slots = parseInt(e.target.innerHTML, 10);\n\t\t\t\t\tconst spelllist = document.querySelector(`[data-name=\"spells\"][data-subfield=\"${slevel}\"]`);\n\t\t\t\t\tif (!slots) {\n\t\t\t\t\t\t// this covers 0 and NaN\n\t\t\t\t\t\tspelllist.parentNode.classList.add('hidden');\n\t\t\t\t\t} else {\n\t\t\t\t\t\tspelllist.parentNode.classList.remove('hidden');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Do something here... Save?\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * When attributes change\n\t * @param {Object} e event object\n\t */\n\tattributeChange: function (e) {\n\t\tconst field = e.target.parentNode;\n\t\tconst mod_field = field.querySelector('.pc-attribute-mod');\n\n\t\tmod_field.innerText = this.calcAttrMod(e.currentTarget.value);\n\t\tconst attr = e.target.getAttribute('data-name');\n\t\tthis.calcSaveMod(attr);\n\t\tconst skills = Array.from(document.querySelectorAll(`[data-attr=${attr}]`));\n\t\tskills.forEach((el) => {\n\t\t\tthis.calcSkillMod(el);\n\t\t});\n\t\tthis.dialog_unsaved.classList.add('open');\n\t},\n\t/**\n\t * When a save is checked\n\t * @param {Object} e event object\n\t */\n\tsaveChange: function (e) {\n\t\tconst attr = e.currentTarget.getAttribute('data-subfield');\n\t\tthis.calcSaveMod(attr);\n\t\tthis.dialog_unsaved.classList.add('open');\n\t},\n\t/**\n\t * When a skill is checked\n\t * @param {Object} e event object\n\t */\n\tskillChange: function (e) {\n\t\tthis.calcSkillMod(e.currentTarget);\n\t\tthis.dialog_unsaved.classList.add('open');\n\t},\n\t/**\n\t * Check for enter in spell list to add a new LI\n\t * @param {Object} e event object\n\t */\n\tspellKeyPress: function (e) {\n\t\tif (e.target.tagName === 'LI' || e.target.closest(`li`)) {\n\t\t\tif (e.which === 13) {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst li = document.createElement('li');\n\t\t\t\tli.setAttribute('contenteditable', 'true');\n\t\t\t\te.currentTarget.appendChild(li);\n\t\t\t\tli.focus();\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * Run after the Manager renders a loaded/restored character\n\t */\n\tpostRender: function () {\n\t\tthis.calcProfMod();\n\t\tthis.attribute_fields.forEach((el) => {\n\t\t\tconst event = new Event('change');\n\t\t\tel.dispatchEvent(event);\n\t\t});\n\t\tthis.dialog_unsaved.classList.remove('open');\n\t},\n\t/**\n\t * Add all the event handlers\n\t */\n\tinitialize: function () {\n\t\t/**\n\t\t * Event: Listen for contenteditable changes\n\t\t * delegate focus/blur from container (body didn't seem to work)\n\t\t * use a temporary data-before attribute to check for change\n\t\t */\n\t\tdocument.querySelector('.container').addEventListener('focus', this.contentEditableFocus.bind(this), true);\n\t\tdocument.querySelector('.container').addEventListener('blur', this.contentEditableBlur.bind(this), true);\n\t\t/**\n\t\t * Event: When attributes change update the related modifier\n\t\t */\n\t\tthis.attribute_fields.forEach((el) => {\n\t\t\tel.addEventListener('change', this.attributeChange.bind(this));\n\t\t});\n\t\t/**\n\t\t * Event: When save is checked recalc save mod\n\t\t */\n\t\tthis.attribute_saves.forEach((el) => {\n\t\t\tel.addEventListener('change', this.saveChange.bind(this));\n\t\t});\n\t\t/**\n\t\t * Event: When a skill is un/checked adjust the modifier\n\t\t */\n\t\tthis.skill_checks.forEach((el) => {\n\t\t\tel.addEventListener('change', this.skillChange.bind(this));\n\t\t});\n\t\t/**\n\t\t * Event: Add new li to spell lists when adding to the last item in the list\n\t\t */\n\t\tthis.spell_lists.forEach((el) => {\n\t\t\tel.addEventListener('keypress', this.spellKeyPress.bind(this));\n\t\t});\n\t}\n};\n\n/**\n * Dialog for when there are no saved characters\n * @return {Array} DOMelements\n */\nconst intro = function () {\n\tconst content = [];\n\tconst h = document.createElement('h2');\n\th.innerHTML = 'Character Sheet. 5e.';\n\tcontent.push(h);\n\tconst p1 = document.createElement('p');\n\tp1.innerHTML = `An online character sheet for 5th edition D&D, usable offline (in some browsers).`;\n\tcontent.push(p1);\n\tconst p4 = document.createElement('p');\n\tp4.innerHTML = `Designed for modern browsers, if all else fails Chrome is your best bet and IE is your worst bet.`;\n\tcontent.push(p4);\n\tconst p2 = document.createElement('p');\n\tp2.innerHTML = `<strong>Warning:</strong> Character data is saved to your browser's local storage. This means it can be erased if you delete browser data and will not automatically transfer between browsers even on the same computer. Please Save and Backup often (or at least at the end of every gaming session)!`;\n\tcontent.push(p2);\n\tconst p3 = document.createElement('p');\n\tp3.innerHTML = `This message will only appear until you save your first character.`;\n\tcontent.push(p3);\n\treturn content;\n};\n\nmodule.exports = {\n\tmodel: character_model,\n\tui: ui,\n\tintro: intro\n};\n","/**\n * Manager:\n * Interface for save/backup/restore of data...\n */\n\n/**\n * LocalStorage interface\n */\nconst Storage = {\n\t/**\n\t * A prefix to attack to the random keys to differentiate them from any other storage for the current location/domain\n\t */\n\tprefix: '',\n\t/**\n\t * Set the prefix\n\t * @param {String} prefix string to prefix the randomly generated key\n\t */\n\tsetPrefix: function (prefix) {\n\t\tthis.prefix = prefix;\n\t},\n\t/**\n\t * Returns blank or the value for the key\n\t * @param {String} key\n\t * @return {Object|String} object or the empty string\n\t */\n\tget: function (key) {\n\t\tlet txt = localStorage.getItem(`${this.prefix}${key}`);\n\t\t// backward compatibile cleanup later @todo\n\t\tif (txt === null) {\n\t\t\ttxt = localStorage.getItem(key);\n\t\t\tif (txt !== null) {\n\t\t\t\tthis.set(key, txt);\n\t\t\t}\n\t\t}\n\t\treturn (txt !== null) ? JSON.parse(txt) : '';\n\t},\n\t/**\n\t * Store a value for the key\n\t * Warning: browsers vary for the amount of data you can store (usually ~5mb)\n\t * @param {String} key\n\t * @param {String} txt\n\t * @return {Boolean} returns false on error\n\t */\n\tset: function (key, txt) {\n\t\ttry {\n\t\t\tlocalStorage.setItem(`${this.prefix}${key}`, JSON.stringify(txt));\n\t\t\t// backwards compatible cleanup for non prefixed saved characters @todo remove\n\t\t\tif (localStorage.getItem(key) !== null) {\n\t\t\t\tlocalStorage.removeItem(key);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t// Should only happen when over quota\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t},\n\t/**\n\t * Remove a key\n\t * @param {String} key\n\t * @return void\n\t */\n\tremove: function (key) {\n\t\tlocalStorage.removeItem(`${this.prefix}${key}`);\n\t},\n\t/**\n\t * Get an array of all keys with the key prefix\n\t * @return {Array}\n\t */\n\tgetAllKeys: function () {\n\t\tconst keys = [];\n\t\tif (localStorage.length > 0) {\n\t\t\tconst key_regex = new RegExp(`^(${this.prefix})+`, 'i');\n\t\t\tfor (let i = 0; i < localStorage.length; i++) {\n\t\t\t\tlet key = localStorage.key(i);\n\t\t\t\t// check for prefix\n\t\t\t\tif (key.indexOf(this.prefix) !== 0) {\n\t\t\t\t\t// backwards compatibility for a little while @todo remove\n\t\t\t\t\tif (!key.match(/^[a-z0-9]{7}$/)) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tkey = key.replace(key_regex, '');\n\t\t\t\tkeys.push(key);\n\t\t\t}\n\t\t}\n\t\treturn keys;\n\t}\n};\n\n/**\n * Menu and associated action events\n */\nconst ActionMenu = {\n\t/**\n\t * Menu element\n\t */\n\tel: null,\n\t/**\n\t * Menu open button\n\t */\n\topener: null,\n\t/**\n\t * Add event handlers, etc.\n\t * @param {Object} Manager the object\n\t */\n\tinitialize: function () {\n\t\tthis.el = document.querySelector('.app-actions');\n\t\tthis.opener = document.querySelector('.btn-open-actions');\n\t\t// opener click handler\n\t\tthis.opener.addEventListener('click', (e) => {\n\t\t\tif (this.el.classList.contains('open')) {\n\t\t\t\t// set menu to hide overflow BEFORE it closes\n\t\t\t\tthis.el.style.overflow = 'hidden';\n\t\t\t}\n\t\t\tthis.el.classList.toggle('open');\n\t\t});\n\t\t// When the menu transitions to open we want to set overflow to visible so the Load dropdown can be visible\n\t\tthis.el.addEventListener('transitionend', (e) => {\n\t\t\tconst style = window.getComputedStyle(this.el);\n\t\t\tif (style.getPropertyValue('max-height') !== '0px') {\n\t\t\t\tthis.el.style.overflow = 'visible';\n\t\t\t}\n\t\t});\n\n\t\t// event handlers for all the menu buttons\n\t\tconst action_btn_backup = this.el.querySelector('.btn-backup');\n\t\taction_btn_backup.addEventListener('click', (e) => {\n\t\t\tBackupDialog.open('download');\n\t\t});\n\t\tconst action_btn_save = this.el.querySelector('.btn-save');\n\t\taction_btn_save.addEventListener('click', (e) => {\n\t\t\tManager.saveCharacter();\n\t\t});\n\t\tconst action_btn_new = this.el.querySelector('.btn-new-character');\n\t\taction_btn_new.addEventListener('click', (e) => {\n\t\t\t// change hash to trigger new character?\n\t\t\twindow.location.hash = `#${Manager.generateKey()}`;\n\t\t});\n\t\tconst action_btn_restore = this.el.querySelector('.btn-restore-backup');\n\t\taction_btn_restore.addEventListener('click', (e) => {\n\t\t\tBackupDialog.open('restore');\n\t\t});\n\t\tconst action_btn_load = this.el.querySelector('.btn-load');\n\t\taction_btn_load.addEventListener('click', (e) => {\n\t\t\tLoadMenu.toggle();\n\t\t});\n\t}\n};\n\n/**\n * Load Menu\n */\nconst LoadMenu = {\n\t/**\n\t * DOMELement\n\t */\n\tel: document.querySelector('#character_list'),\n\t/**\n\t * Open menu\n\t */\n\topen: function () {\n\t\tthis.el.classList.add('open');\n\t},\n\t/**\n\t * Toggle menu\n\t */\n\ttoggle: function () {\n\t\tthis.el.classList.toggle('open');\n\t},\n\t/**\n\t * Close menu\n\t */\n\tclose: function () {\n\t\tthis.el.classList.remove('open');\n\t},\n\t/**\n\t * Add character to list\n\t * @param {Object} char_obj Character object or JSON string\n\t */\n\taddCharacter: function (char_obj) {\n\t\tif (typeof char_obj === 'undefined' || char_obj === '') {\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tif (char_obj.key && char_obj.key !== '') {\n\t\t\t\t// check if it's already there\n\t\t\t\tconst existing = this.el.querySelector(`a[href=\"#${char_obj.key}\"]`);\n\t\t\t\tif (existing !== null) {\n\t\t\t\t\t// update the text as appropriate\n\t\t\t\t\texisting.textContent = `${char_obj.charname} (${char_obj.charclass} ${char_obj.level})`;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst li = document.createElement('li');\n\t\t\t\tconst a = document.createElement('a');\n\t\t\t\ta.textContent = `${char_obj.charname} (${char_obj.charclass} ${char_obj.level})`;\n\t\t\t\ta.setAttribute('href', `#${char_obj.key}`);\n\t\t\t\tli.appendChild(a);\n\t\t\t\tconst del = document.createElement('a');\n\t\t\t\tdel.classList.add('delete');\n\t\t\t\tdel.innerHTML = '❌';\n\t\t\t\tdel.setAttribute('href', '#');\n\t\t\t\tdel.setAttribute('data-key', char_obj.key);\n\t\t\t\tli.appendChild(del);\n\t\t\t\tthis.el.querySelector('#saved_characters').appendChild(li);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.log(e.message);\n\t\t}\n\t},\n\t/**\n\t * Remove character from list\n\t * @param {String} key\n\t */\n\tremoveCharacter: function (key) {\n\t\tconst loadlink = this.el.querySelector(`a[href=\"#${key}\"]`);\n\t\tconst li = loadlink.parentNode;\n\t\tli.parentNode.removeChild(li);\n\t},\n\t/**\n\t * Do we have any saved characters here?\n\t * @return {Boolean}\n\t */\n\tisEmpty: function () {\n\t\treturn this.el.querySelector('li') === null;\n\t},\n\t/**\n\t * Set up event handlers\n\t */\n\tinitialize: function () {\n\t\tdocument.body.addEventListener('click', (e) => {\n\t\t\tconst close = e.target.closest(`#${this.el.id}`);\n\t\t\tif (close === null) {\n\t\t\t\t// Ignore the load button (it's already handled elsewhere)\n\t\t\t\tif (e.target.classList.contains('btn-load')) { return; }\n\t\t\t\t// Hide the menus.\n\t\t\t\tthis.close();\n\t\t\t} else {\n\t\t\t\t// delete link in load menu\n\t\t\t\tif (e.target.classList.contains('delete')) {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\tManager.deletePrompt(e.target.getAttribute('data-key'));\n\t\t\t\t\tthis.close();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n};\n\n/**\n * Alert:\n * Main method for showing warnings and other interactions that need prominent placement/attention\n */\nconst Alert = {\n\t/**\n\t * The DOMElement for the alert\n\t */\n\tel: document.querySelector('.alert-main'),\n\t/**\n\t * Add content to alert\n\t * @param {Array|DOMElement} content single DOMElement or Array of DOMElements\n\t */\n\tsetContent: function (content) {\n\t\tif (!Array.isArray(content)) {\n\t\t\tcontent = [content];\n\t\t}\n\t\tthis.clear(); // make sure we start with an empty alert\n\t\tconst f = document.createDocumentFragment();\n\t\tcontent.forEach((el) => {\n\t\t\tf.appendChild(el);\n\t\t});\n\t\tconst btn = document.createElement('button');\n\t\tbtn.setAttribute('type', 'button');\n\t\tbtn.classList.add('close');\n\t\tbtn.textContent = 'Close';\n\t\tf.appendChild(btn);\n\t\tthis.el.appendChild(f);\n\t\tthis.el.classList.add('open');\n\t},\n\t/**\n\t * Clear the alert (which makes it disappear)\n\t */\n\tclear: function () {\n\t\tthis.el.classList.remove('open');\n\t\twhile (this.el.firstChild) {\n\t\t\tthis.el.removeChild(this.el.firstChild);\n\t\t}\n\t},\n\t/**\n\t * Setup some events, etc.\n\t * @param {Object} Manager instance of manager object\n\t */\n\tinitialize: function () {\n\t\tthis.el.addEventListener('click', (e) => {\n\t\t\tif (e.target.classList.contains('close')) {\n\t\t\t\t// close button click\n\t\t\t\te.preventDefault();\n\t\t\t\tthis.clear();\n\t\t\t} else if (e.target.classList.contains('delete-conf')) {\n\t\t\t\t// delete confirmation\n\t\t\t\tconst key = e.target.getAttribute('data-key');\n\t\t\t\tthis.clear();\n\t\t\t\tManager.deleteCharacter(key);\n\t\t\t}\n\t\t});\n\t}\n};\n\nconst HelpDialog = {\n\t/**\n\t * Dialog element\n\t */\n\tel: document.getElementById('dialog_help'),\n\t/**\n\t * Help button\n\t */\n\topener: document.querySelector('.btn-help'),\n\t/**\n\t * Close button\n\t */\n\tcloser: document.querySelector('#dialog_help .close'),\n\t/**\n\t * Add events\n\t */\n\tinitialize: function () {\n\t\t// Event: click opener\n\t\tthis.opener.addEventListener('click', (e) => {\n\t\t\tthis.el.classList.add('open');\n\t\t\tthis.el.querySelector('h1').focus();\n\t\t});\n\t\t// Event: click closer\n\t\tthis.closer.addEventListener('click', (e) => {\n\t\t\tthis.el.classList.remove('open');\n\t\t});\n\t\t// Event: click outside help dialog to close it\n\t\tdocument.body.addEventListener('click', (e) => {\n\t\t\tconst close = e.target.closest('#dialog_help');\n\t\t\tif (close === null) {\n\t\t\t\tif (e.target.classList.contains('btn-help')) { return; }\n\t\t\t\t// Hide the help.\n\t\t\t\tthis.el.classList.remove('open');\n\t\t\t}\n\t\t});\n\t}\n};\n\nconst BackupDialog = {\n\t/**\n\t * Dialog element\n\t */\n\tel: document.getElementById('dialog-backup'),\n\t/**\n\t * Open Dialog\n\t * @param {String} type which form to open in the dialog\n\t */\n\topen: function (type) {\n\t\tif (type === 'restore') {\n\t\t\tthis.addRestoreForm();\n\t\t} else if (type === 'download') {\n\t\t\tthis.addDownloadForm();\n\t\t}\n\t\tthis.el.classList.add('open');\n\t\tthis.el.querySelector('legend').focus();\n\t},\n\t/**\n\t * Close Dialog (and clear form)\n\t */\n\tclose: function () {\n\t\tthis.el.classList.remove('open');\n\t\twhile (this.el.firstChild) {\n\t\t\tthis.el.removeChild(this.el.firstChild);\n\t\t}\n\t},\n\t/**\n\t * Return a close button to use\n\t * @return {DOMElement} button.close\n\t */\n\tgetCloseButton: function () {\n\t\tconst button = document.createElement('button');\n\t\tbutton.setAttribute('type', 'button');\n\t\tbutton.classList.add('close');\n\t\tbutton.textContent = 'Close';\n\t\treturn button;\n\t},\n\t/**\n\t * Add the restore form\n\t */\n\taddRestoreForm: function () {\n\t\tconst form = document.createElement('form');\n\t\tform.id = 'form_backup_restore';\n\t\tconst fields = `<label for=\"files\">Restore from file</label>\n\t\t\t<input type=\"file\" id=\"files\" name=\"files\" />\n\t\t\t<p>or</p>\n\t\t\t<label for=\"backup_data\">Paste the character backup data</label>\n\t\t\t<textarea id=\"backup_data\" name=\"backup_data\"></textarea>\n\t\t\t<button type=\"submit\">Restore</button>\n\t\t\t<button type=\"button\">Cancel</button>`;\n\t\tform.innerHTML = fields;\n\t\tform.addEventListener('submit', (e) => {\n\t\t\tManager.restoreFormSubmit(e);\n\t\t});\n\t\tthis.el.appendChild(form);\n\t},\n\t/**\n\t * Add the download options\n\t */\n\taddDownloadForm: function () {\n\t\tconst form = document.createElement('form');\n\t\tform.id = 'form_backup_download';\n\n\t\tconst checkboxes = [];\n\t\tStorage.getAllKeys().forEach((key) => {\n\t\t\tconst char_obj = Storage.get(key);\n\t\t\tif (!char_obj.key) { return; }\n\t\t\tconst li = `<li><label><input type=\"checkbox\" name=\"${char_obj.key}\" value=\"${char_obj.key}\" /> ${char_obj.charname} (${char_obj.charclass} ${char_obj.level})</label></li>`;\n\t\t\tcheckboxes.push(li);\n\t\t});\n\n\t\tconst fields = `<fieldset>\n\t\t\t<legend tabindex=\"-1\">Pick characters to download.</legend>\n\t\t\t<ul>\n\t\t\t\t${checkboxes.join('')}\n\t\t\t</ul>\n\t\t</fieldset>\n\t\t<fieldset>\n\t\t\t<legend>Pick a format</legend>\n\t\t\t<ul>\n\t\t\t<li><label><input type=\"radio\" name=\"format\" value=\"file\" checked> File download</label></li>\n\t\t\t<li><label><input type=\"radio\" name=\"format\" value=\"email\"> Email data</label></li>\n\t\t</fieldset>\n\t\t<button type=\"submit\">Download</button>\n\t\t<button type=\"button\">Cancel</button>`;\n\t\tform.innerHTML = fields;\n\t\tform.addEventListener('submit', (e) => {\n\t\t\tManager.downloadBackup(e);\n\t\t});\n\t\tthis.el.appendChild(form);\n\t},\n\t/**\n\t * If file download is unavailable offer the data to copy/paste\n\t * @param {String} data the backup data\n\t */\n\taltDownload: function (data) {\n\t\tconst p = document.createElement('p');\n\t\tp.innerHTML = `Your current browser/os does not support direct file downloads, so here is the data for you to copy/paste.`;\n\t\tconst text = document.createElement('textarea');\n\t\ttext.classList.add('large');\n\t\ttext.value = data;\n\t\twhile (this.el.firstChild) {\n\t\t\tthis.el.removeChild(this.el.firstChild);\n\t\t}\n\t\tthis.el.appendChild(p);\n\t\tthis.el.appendChild(text);\n\t\tthis.el.appendChild(this.getCloseButton());\n\t\ttext.focus();\n\t\ttext.select();\n\t},\n\t/**\n\t * Email download link\n\t * @param {DOMElement} link the email link\n\t */\n\temailDownload: function (link) {\n\t\tconst p = document.createElement('p');\n\t\tp.appendChild(link);\n\t\twhile (this.el.firstChild) {\n\t\t\tthis.el.removeChild(this.el.firstChild);\n\t\t}\n\t\tthis.el.appendChild(p);\n\t\tthis.el.appendChild(this.getCloseButton());\n\t},\n\t/**\n\t * Add events\n\t */\n\tinitialize: function () {\n\t\t// Event: click closer\n\t\tthis.el.addEventListener('click', (e) => {\n\t\t\tif (e.target.tagName === 'BUTTON' && e.target.getAttribute('type') === 'button') {\n\t\t\t\tthis.close();\n\t\t\t}\n\t\t});\n\t}\n};\n\nconst Manager = module.exports = {\n\t/**\n\t * App/rules/game specific character model and UI handling\n\t */\n\tcharacter_model: null,\n\t/**\n\t * App/rules/game specific UI handling\n\t */\n\trules_ui: null,\n\t/**\n\t * Currently loaded character data is here\n\t */\n\tcur_character: null,\n\t/**\n\t * App name used in character model app property\n\t */\n\tappname: '',\n\t/**\n\t * Unsaved dialog\n\t */\n\tdialog_unsaved: document.querySelector('.alert-unsaved'),\n\t/**\n\t * Get a json string as a character backup of the current character\n\t * In this way we make sure any new properties are included in the backup when saving\n\t * @return {String}\n\t */\n\tcharacterJSON: function () {\n\t\tconst obj = {};\n\t\tfor (const prop in this.cur_character) {\n\t\t\tobj[prop] = this.cur_character[prop];\n\t\t}\n\t\treturn JSON.stringify(obj);\n\t},\n\t/**\n\t * Return UTC datetime string for right now\n\t * @return {String}\n\t */\n\tcurrentTimestamp: function () {\n\t\tconst d = new Date();\n\t\treturn d.toUTCString();\n\t},\n\t/**\n\t * Generate a random key for character storage\n\t * make sure key is not already existing\n\t * @return {String}\n\t */\n\tgenerateKey: function () {\n\t\tlet key = (`${Math.random().toString(36)}00000000000000000`).slice(2, 9);\n\t\twhile (Storage.get(key) !== '') {\n\t\t\tkey = (`${Math.random().toString(36)}00000000000000000`).slice(2, 9);\n\t\t}\n\t\treturn key;\n\t},\n\t/**\n\t * Set data on character object\n\t */\n\tsetCurCharacterData: function (data) {\n\t\tif (typeof data !== 'object') { return; }\n\t\tconst props = Object.keys(data);\n\t\tprops.forEach((prop) => {\n\t\t\tif (typeof this.cur_character[prop] !== 'undefined') {\n\t\t\t\tthis.cur_character[prop] = data[prop];\n\t\t\t}\n\t\t});\n\t},\n\t/**\n\t * Change the character based on a hash change\n\t * or maybe I should process the event in the handler and pass it here if necessary...\n\t * @param {Object} e event object from hash change\n\t */\n\tchangeCharacter: function () {\n\t\tconst urlhash = window.location.hash.substr(1);\n\t\tthis.loadCharacter(urlhash);\n\t\tLoadMenu.close();\n\t},\n\t/**\n\t * Load character data based on a key\n\t * @param {String} key character identifier...????\n\t */\n\tloadCharacter: function (key) {\n\t\tthis.dialog_unsaved.classList.remove('open');\n\t\tconst data = Storage.get(key);\n\t\tif (data === '') {\n\t\t\t// prompt to load backup?\n\t\t\tthis.cur_character = Object.create(this.character_model);\n\t\t\tthis.cur_character.key = key;\n\t\t\tthis.renderCharacter();\n\t\t\treturn;\n\t\t}\n\t\tthis.cur_character = Object.create(this.character_model);\n\t\tthis.setCurCharacterData(data);\n\t\tthis.renderCharacter();\n\t},\n\t/**\n\t * Take character data and fill it into the page\n\t */\n\trenderCharacter: function () {\n\t\tif (this.cur_character === null) { return; }\n\t\tconst fields = Array.from(document.querySelectorAll('*[data-name]'));\n\t\tfields.forEach((el) => {\n\t\t\tconst f = el.getAttribute('data-name');\n\t\t\tif (typeof this.cur_character[f] === 'undefined') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst subf = el.getAttribute('data-subfield');\n\t\t\tif (subf !== null) {\n\t\t\t\tif (typeof this.cur_character[f][subf] === 'undefined') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (typeof this.cur_character[f] !== 'undefined') {\n\t\t\t\tswitch (el.tagName) {\n\t\t\t\t\tcase 'INPUT':\n\t\t\t\t\tcase 'SELECT':\n\t\t\t\t\tcase 'TEXTAREA':\n\t\t\t\t\t\tif (el.getAttribute('type') === 'checkbox') {\n\t\t\t\t\t\t\tconst checked = (subf) ? this.cur_character[f][subf] : this.cur_character[f];\n\t\t\t\t\t\t\tif (checked === 1) {\n\t\t\t\t\t\t\t\tel.checked = true;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tel.checked = false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tel.value = (subf) ? this.cur_character[f][subf] : this.cur_character[f];\n\t\t\t\t\t\tconst event = new Event('change');\n\t\t\t\t\t\tel.dispatchEvent(event);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'UL':\n\t\t\t\t\t\t// clear list\n\t\t\t\t\t\twhile (el.firstChild) {\n\t\t\t\t\t\t\tel.removeChild(el.firstChild);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet items = (subf) ? this.cur_character[f][subf] : this.cur_character[f];\n\t\t\t\t\t\tif (!Array.isArray(items)) { items = items.split(/;|<br\\/?>/); }\n\t\t\t\t\t\tconst li_blank = el.querySelector('li:empty');\n\t\t\t\t\t\tif (items.length > 0) {\n\t\t\t\t\t\t\titems.forEach((i) => {\n\t\t\t\t\t\t\t\tif (i === '') { return; }\n\t\t\t\t\t\t\t\tconst li = document.createElement('li');\n\t\t\t\t\t\t\t\tli.setAttribute('contenteditable', 'true');\n\t\t\t\t\t\t\t\tli.innerHTML = i;\n\t\t\t\t\t\t\t\tel.insertBefore(li, li_blank);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// add a blank one at the end\n\t\t\t\t\t\tconst li = document.createElement('li');\n\t\t\t\t\t\tli.setAttribute('contenteditable', 'true');\n\t\t\t\t\t\tel.appendChild(li);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tel.innerHTML = (subf) ? this.cur_character[f][subf] : this.cur_character[f];\n\t\t\t\t\t\tconst event2 = new Event('blur');\n\t\t\t\t\t\tel.dispatchEvent(event2);\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\t// Update proficiency/attr/save/skill modifiers\n\t\tthis.rules_ui.postRender();\n\t},\n\t/**\n\t * Save character data to localStorage\n\t */\n\tsaveCharacter: function () {\n\t\tif (this.cur_character === null) {\n\t\t\tthis.cur_character = Object.create(this.character_model);\n\t\t}\n\t\tconst fields = Array.from(document.querySelectorAll('*[data-name]'));\n\t\tfields.forEach((el) => {\n\t\t\tconst f = el.getAttribute('data-name');\n\t\t\tif (typeof this.cur_character[f] === 'undefined') {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst subf = el.getAttribute('data-subfield');\n\t\t\tif (subf !== null) {\n\t\t\t\tif (typeof this.cur_character[f][subf] === 'undefined') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// for some reason trying to set the property of an object that is a property on the prototype\n\t\t\t\t// does not get the object to exist as an own property...\n\t\t\t\tif (!this.cur_character.hasOwnProperty(f)) {\n\t\t\t\t\tthis.cur_character[f] = this.character_model[f];\n\t\t\t\t}\n\t\t\t}\n\t\t\tswitch (el.tagName) {\n\t\t\t\tcase 'INPUT':\n\t\t\t\tcase 'SELECT':\n\t\t\t\tcase 'TEXTAREA':\n\t\t\t\t\tif (el.getAttribute('type') === 'checkbox') {\n\t\t\t\t\t\tconst checked = el.checked ? 1 : 0;\n\t\t\t\t\t\tif (subf) {\n\t\t\t\t\t\t\tthis.cur_character[f][subf] = checked;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.cur_character[f] = checked;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tif (subf) {\n\t\t\t\t\t\tthis.cur_character[f][subf] = el.value;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.cur_character[f] = el.value;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'UL':\n\t\t\t\t\tconst items = [];\n\t\t\t\t\tconst lis = Array.from(el.querySelectorAll('li'));\n\t\t\t\t\tif (lis.length > 0) {\n\t\t\t\t\t\tlis.forEach((li) => {\n\t\t\t\t\t\t\tconst val = li.innerHTML;\n\t\t\t\t\t\t\tif (val === '') { return; }\n\t\t\t\t\t\t\titems.push(val);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tif (subf) {\n\t\t\t\t\t\tthis.cur_character[f][subf] = items;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.cur_character[f] = items;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tif (subf) {\n\t\t\t\t\t\tthis.cur_character[f][subf] = el.innerHTML;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.cur_character[f] = el.innerHTML;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\t\tif (this.cur_character.charname === '') {\n\t\t\tconst p = document.createElement('p');\n\t\t\tp.innerHTML = 'Your character must have name to save!';\n\t\t\tAlert.setContent(p);\n\t\t\treturn;\n\t\t}\n\t\t// update saved timestamp\n\t\tthis.cur_character.updated = this.currentTimestamp();\n\t\t// make sure app name is set\n\t\tthis.cur_character.app = this.appname;\n\t\tStorage.set(this.cur_character.key, this.cur_character);\n\t\tthis.dialog_unsaved.classList.remove('open');\n\t\tLoadMenu.addCharacter(this.cur_character);\n\t},\n\t/**\n\t * Save a file of the current character\n\t * Falls back to showing the data for copy/pasting\n\t * @param {Object} e event object from form submit\n\t */\n\tdownloadBackup: function (e) {\n\t\te.preventDefault();\n\t\tconst data = [];\n\t\tconst names = [];\n\t\tconst form = e.target;\n\t\tconst checks = Array.from(form.querySelectorAll('input[type=checkbox]:checked'));\n\t\tchecks.forEach((ch) => {\n\t\t\tconst char_obj = Storage.get(ch.value);\n\t\t\tdata.push(char_obj);\n\t\t\tnames.push(char_obj.charname);\n\t\t});\n\n\t\tconst format = form.querySelector('input[name=format]:checked').value;\n\t\tconst date = new Date();\n\n\t\tif (format === 'email') {\n\t\t\tconst body = `Below is the backup data for your character(s) ${names.join(', ')}.\n\nTo use this data, go to: ${window.location.href} and click the \"Restore Backup\" button. Then paste the text below into the box.\n\n---\n\n${JSON.stringify(data)}`;\n\n\t\t\tconst url = `mailto:?subject=${encodeURIComponent(`Character backup: ${names.join(', ')} (${date.toLocaleString()})`)}&body=${encodeURIComponent(body)}`;\n\n\t\t\t// Sadly this simple solution doesn't work in iOS\n\t\t\t// document.location.href = url;\n\t\t\tconst a = document.createElement('a');\n\t\t\ta.href = url;\n\t\t\ta.innerHTML = 'Open new message in default email client';\n\t\t\ta.addEventListener('click', (e) => {\n\t\t\t\tBackupDialog.close();\n\t\t\t});\n\t\t\tBackupDialog.emailDownload(a);\n\t\t} else {\n\t\t\tif (typeof window.Blob !== 'function') {\n\t\t\t\t// fallback to displaying the data for copy/pasting\n\t\t\t\tBackupDialog.altDownload(JSON.stringify(data));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// for env that support it, create a file for download\n\t\t\tconst a = document.createElement('a');\n\t\t\tconst file = new Blob([JSON.stringify(data)], { type: 'application/json' });\n\t\t\tconst url = URL.createObjectURL(file);\n\t\t\ta.href = url;\n\t\t\ta.download = `${this.appname}_${date.getFullYear()}_${date.getMonth() + 1}_${date.getDate()}`;\n\t\t\tdocument.body.appendChild(a);\n\t\t\ta.click();\n\t\t\tsetTimeout(function () {\n\t\t\t\tdocument.body.removeChild(a);\n\t\t\t\twindow.URL.revokeObjectURL(url);\n\t\t\t}, 0);\n\t\t}\n\t},\n\t/**\n\t * Restore Backup form handler\n\t * @param {Object} e Form submit event\n\t */\n\trestoreFormSubmit: function (e) {\n\t\te.preventDefault();\n\t\tconst input_file = e.target.querySelector('input[type=file]');\n\t\tconst input = e.target.querySelector('textarea');\n\t\tif (input_file.files && input_file.files.length > 0) {\n\t\t\tArray.from(input_file.files).forEach((f) => {\n\t\t\t\tconst reader = new FileReader();\n\t\t\t\t// Closure to capture the file information.\n\t\t\t\treader.onload = ((theFile) => {\n\t\t\t\t\treturn (e) => {\n\t\t\t\t\t\tthis.restoreCharacters(e.target.result);\n\t\t\t\t\t};\n\t\t\t\t})(f);\n\t\t\t\treader.readAsText(f);\n\t\t\t});\n\t\t} else if (input.value !== '') {\n\t\t\tthis.restoreCharacters(input.value);\n\t\t}\n\t\tBackupDialog.close();\n\t},\n\t/**\n\t * Take json backup data and load the character(s)\n\t * @param {String} data JSON string we hope\n\t */\n\trestoreCharacters: function (data) {\n\t\ttry {\n\t\t\t// look for the start of the JSON string Array of Objects\n\t\t\tlet start = data.indexOf('[{');\n\t\t\tlet end = data.lastIndexOf('}]');\n\t\t\t// make sure it's not :[{, an array of objects inside one of the objects\n\t\t\tconst check = data.indexOf(':[{');\n\t\t\tif (check !== -1 && check < start) {\n\t\t\t\t// if so start over\n\t\t\t\tstart = -1;\n\t\t\t}\n\t\t\tif (start === -1) {\n\t\t\t\tstart = data.indexOf('{');\n\t\t\t\tend = data.lastIndexOf('}');\n\t\t\t\tdata = data.substring(start);\n\t\t\t\tdata = data.substring(0, end + 1);\n\t\t\t} else {\n\t\t\t\tdata = data.substring(start);\n\t\t\t\tdata = data.substring(0, end + 2);\n\t\t\t}\n\t\t\tdata = data.trim(); // just in case\n\n\t\t\t// convert linebreaks to html br else JSON.parse breaks\n\t\t\t// first make sure it's not a break between objects...\n\t\t\tdata = data.replace(/\\},[\\r\\n]+\\{/g, '},{');\n\t\t\tdata = data.replace(/(?:\\r\\n|\\r|\\n)/g, '<br/>');\n\t\t\tlet backups = JSON.parse(data);\n\t\t\t// make it an array\n\t\t\tif (!Array.isArray(backups)) {\n\t\t\t\tbackups = [backups];\n\t\t\t}\n\t\t\tconst imported_chars = [];\n\t\t\tbackups.forEach((char_obj) => {\n\t\t\t\t// is it a char object for this app\n\t\t\t\tif (typeof char_obj !== 'object' || !char_obj.key || char_obj.app !== this.appname) {\n\t\t\t\t\tthrow new Error(`Data appears to be invalid. Try removing any text that isn't part of the backup (i.e. email introduction).`);\n\t\t\t\t}\n\t\t\t\t// do we have this char key already\n\t\t\t\tconst ex_char = Storage.get(char_obj.key);\n\t\t\t\tif (ex_char !== '' && ex_char.charname !== '' && ex_char.charname !== char_obj.charname) {\n\t\t\t\t\t// existing key but different name\n\t\t\t\t\tif (!char_obj.key_prev) {\n\t\t\t\t\t\tchar_obj.key_prev = char_obj.key;\n\t\t\t\t\t\tchar_obj.key = this.generateKey();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst temp_key = char_obj.key_prev;\n\t\t\t\t\t\tchar_obj.key_prev = char_obj.key;\n\t\t\t\t\t\tchar_obj.key = temp_key;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tStorage.set(char_obj.key, char_obj);\n\t\t\t\tLoadMenu.addCharacter(char_obj);\n\t\t\t\t// if its the current character we should reload them\n\t\t\t\tif (char_obj.key === this.cur_character.key) {\n\t\t\t\t\tthis.loadCharacter(char_obj.key);\n\t\t\t\t}\n\t\t\t\tconst li = document.createElement('li');\n\t\t\t\tli.textContent = `${char_obj.charname} has been added. `;\n\t\t\t\tconst a = document.createElement('a');\n\t\t\t\ta.setAttribute('href', `#${char_obj.key}`);\n\t\t\t\ta.textContent = 'View character now.';\n\t\t\t\ta.addEventListener('click', (e) => {\n\t\t\t\t\tAlert.clear();\n\t\t\t\t});\n\t\t\t\tli.appendChild(a);\n\t\t\t\timported_chars.push(li);\n\t\t\t});\n\n\t\t\tconst ul = document.createElement('ul');\n\t\t\timported_chars.forEach((li) => {\n\t\t\t\tul.appendChild(li);\n\t\t\t});\n\t\t\tAlert.setContent(ul);\n\t\t} catch (e) {\n\t\t\tconst p = document.createElement('p');\n\t\t\tp.innerHTML = `Error processing backup data: ${e.message}`;\n\t\t\tAlert.setContent(p);\n\t\t}\n\t},\n\t/**\n\t * Prompt to confirm deletion of character\n\t * @param {String} key character key\n\t */\n\tdeletePrompt: function (key) {\n\t\tconst data = Storage.get(key);\n\t\tif (data === '') {\n\t\t\treturn;\n\t\t}\n\t\tconst content = [];\n\t\tconst p = document.createElement('p');\n\t\tp.innerHTML = `Are you sure you want to delete the character: ${(data.charname) ? data.charname : '[Unnamed]'}`;\n\t\tcontent.push(p);\n\t\tconst btn = document.createElement('button');\n\t\tbtn.innerHTML = 'Yes, Delete.';\n\t\tbtn.setAttribute('data-key', data.key);\n\t\tbtn.classList.add('delete-conf');\n\t\tcontent.push(btn);\n\t\tAlert.setContent(content);\n\t},\n\t/**\n\t * Delete a character from local storage\n\t * @param {String} key character key\n\t */\n\tdeleteCharacter: function (key) {\n\t\tif (key === '' || key === 'settings') { return; }\n\t\tStorage.remove(key);\n\t\tif (Storage.get(key) !== '') {\n\t\t\t// error\n\t\t\tconst p = document.createElement('p');\n\t\t\tp.innerHTML = `Error deleting the character...`;\n\t\t\tAlert.setContent(p);\n\t\t} else {\n\t\t\t// success\n\t\t\t// remove from load list\n\t\t\tLoadMenu.removeCharacter(key);\n\t\t\t// if its the current character we should trigger \"new character\" action\n\t\t\tif (this.cur_character !== null && this.cur_character.key === key) {\n\t\t\t\twindow.location.hash = `#${Manager.generateKey()}`;\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * Check for features we need\n\t * @return {Boolean}\n\t */\n\tcheckFeatures: function () {\n\t\tlet fail = false;\n\t\tif ('localStorage' in window && window['localStorage'] !== null) {\n\t\t\t// Okay\n\t\t} else {\n\t\t\tfail = true;\n\t\t}\n\t\tif (fail) {\n\t\t\tconst p = document.createElement('p');\n\t\t\tp.textContent = `Sorry, your browser does not supported the required features for this app to work. Try using the latest Chrome or Firefox for best results.`;\n\t\t\tAlert.setContent(p);\n\t\t}\n\t\treturn;\n\t},\n\t/**\n\t * Check for AppCache updates\n\t */\n\tcheckCache: function () {\n\t\tif ('applicationCache' in window) {\n\t\t\tconst updateAppCache = function (event) {\n\t\t\t\tconst p = document.createElement('p');\n\t\t\t\tp.textContent = `Character Sheet has been updated with new features or bug fixes. Please reload the page to get the newest code. If you have this site open in multiple tabs/windows please close them all.`;\n\t\t\t\tAlert.setContent(p);\n\t\t\t};\n\t\t\twindow.applicationCache.addEventListener('updateready', updateAppCache, false);\n\t\t\tif (window.applicationCache.status === window.applicationCache.UPDATEREADY) {\n\t\t\t\tupdateAppCache();\n\t\t\t}\n\t\t}\n\t},\n\t/**\n\t * If no characters are saved we show an app intro dialog\n\t */\n\tshowIntroDialog: function () {\n\t\tAlert.setContent(this.intro());\n\t},\n\t/**\n\t * Start up the app with some events and such\n\t * @param {Object} settings things we need to set external to this script\n\t * @param {Object} settings.rules export object from the rules specific module\n\t * @param {String} settings.prefix prefix for localStorage keys\n\t * @param {String} settings.appname used to identify the app property in a character model\n\t */\n\tinitialize: function (settings) {\n\t\tif (!settings.rules || !settings.prefix || !settings.appname) {\n\t\t\tdocument.body.innerHTML = '<p>App is missing required settings.</p>';\n\t\t\treturn;\n\t\t}\n\t\tthis.character_model = settings.rules.model;\n\t\tthis.rules_ui = settings.rules.ui;\n\t\tthis.appname = settings.appname;\n\t\tthis.intro = settings.rules.intro;\n\t\t// set up storage\n\t\tStorage.setPrefix(settings.prefix);\n\t\t// set up default Alert\n\t\tAlert.initialize();\n\t\t// check for localStorage support\n\t\tthis.checkFeatures();\n\t\t// check for AppCache updates\n\t\tthis.checkCache();\n\t\t// set up the help dialog\n\t\tHelpDialog.initialize();\n\t\t// set up the menu\n\t\tActionMenu.initialize();\n\t\t// Load the saved characters into the dropdown\n\t\tLoadMenu.initialize(this);\n\t\tBackupDialog.initialize();\n\n\t\tStorage.getAllKeys().forEach((key) => {\n\t\t\tconst char_obj = Storage.get(key);\n\t\t\tLoadMenu.addCharacter(char_obj);\n\t\t});\n\n\t\tif (LoadMenu.isEmpty()) {\n\t\t\tthis.showIntroDialog();\n\t\t}\n\t\t// set up all the rule specific ui events (attribute modifiers and the like)\n\t\tthis.rules_ui.initialize();\n\n\t\tdocument.querySelector('nav').addEventListener('click', (e) => {\n\t\t\tif (e.target.tagName === 'A') {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst target_id = e.target.getAttribute('href').substring(1);\n\t\t\t\tdocument.getElementById(target_id).scrollIntoView();\n\t\t\t}\n\t\t});\n\n\t\t// Event: Listen for hashchange and change the current character\n\t\twindow.addEventListener('hashchange', (e) => { this.changeCharacter(); }, false);\n\n\t\t// Check the hash to see if we need to load a specific character\n\t\tconst urlhash = window.location.hash.substr(1);\n\t\tif (urlhash !== '') {\n\t\t\tthis.loadCharacter(urlhash);\n\t\t} else {\n\t\t\twindow.location.hash = `#${this.generateKey()}`;\n\t\t}\n\t}\n};\n"]}